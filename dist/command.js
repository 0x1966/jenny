"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Command = void 0;
const jenkins_1 = require("./jenkins");
const files_1 = require("./files");
const output_1 = require("./output");
class Command {
    static of(config) {
        return new Command(config);
    }
    constructor(config) {
        this.config = config;
        this.jenkins = jenkins_1.Jenkins.of(config.baseUrl, config.user, config.token);
    }
    deleteJobsAndViewsBasedOnPath(path) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsAndViews = yield this.jenkins.listJobsAndViews();
            const fileBasedJobsAndViews = yield files_1.Files.of(path, this.config.namePrefix).listJobsAndViews();
            const jenkinsJobsToDelete = jenkinsJobsAndViews.jobs.filter((name) => fileBasedJobsAndViews.jobs.some((job) => job.name === name));
            const jenkinsViewsToDelete = jenkinsJobsAndViews.views.filter((name) => fileBasedJobsAndViews.views.some((view) => view.name === name));
            jenkinsViewsToDelete.forEach((name) => this.jenkins
                .deleteViewByName(name)
                .then((n) => (0, output_1.println)(`[X] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting view "${name}"`, e)));
            jenkinsJobsToDelete.forEach((name) => this.jenkins
                .deleteJobByName(name)
                .then((n) => (0, output_1.println)(`[X] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting job "${name}"`, e)));
        });
    }
    syncJobsAndViewsBasedOnPath(path) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsAndViews = yield this.jenkins.listJobsAndViews();
            const fileBasedJobsAndViews = yield files_1.Files.of(path, this.config.namePrefix).listJobsAndViews();
            yield this.syncJobsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews);
            yield this.syncViewsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews);
        });
    }
    syncJobsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsToDelete = jenkinsJobsAndViews.jobs
                .filter((name) => name.startsWith(this.config.namePrefix))
                .filter((name) => !fileBasedJobsAndViews.jobs.some((job) => job.name === name));
            const fileBasedJobsToCreate = fileBasedJobsAndViews.jobs.filter((job) => !jenkinsJobsAndViews.jobs.some((name) => job.name === name));
            const fileBasedJobsToUpdate = fileBasedJobsAndViews.jobs.filter((job) => jenkinsJobsAndViews.jobs.some((name) => job.name === name));
            jenkinsJobsToDelete.forEach((name) => this.jenkins
                .deleteJobByName(name)
                .then((n) => (0, output_1.println)(`[X] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting job "${name}"`, e)));
            fileBasedJobsToCreate.forEach((job) => this.jenkins
                .createJobFromTemplate(this.config.jobTemplate, job.name, job.script)
                .then((n) => (0, output_1.println)(`[C] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error creating job "${job.name}"`, e)));
            fileBasedJobsToUpdate.forEach((job) => this.jenkins
                .updateJobPipelineScript(job.name, job.script)
                .then((n) => (0, output_1.println)(`[U] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error updating job "${job.name}"`, e)));
        });
    }
    syncViewsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsViewsToDelete = jenkinsJobsAndViews.views
                .filter((name) => name.startsWith(this.config.namePrefix))
                .filter((name) => !fileBasedJobsAndViews.views.some((view) => view.name === name));
            const fileBasedViewsToCreate = fileBasedJobsAndViews.views.filter((view) => !jenkinsJobsAndViews.views.some((name) => view.name === name));
            jenkinsViewsToDelete.forEach((name) => this.jenkins
                .deleteViewByName(name)
                .then((n) => (0, output_1.println)(`[X] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting view "${name}"`, e)));
            fileBasedViewsToCreate.forEach((view) => this.jenkins
                .createRegexBasedListView(view.name, view.regex)
                .then((n) => (0, output_1.println)(`[C] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error creating view "${view.name}"`, e)));
        });
    }
}
exports.Command = Command;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLHVDQUFzRTtBQUN0RSxtQ0FBZ0U7QUFHaEUscUNBQTRDO0FBRTVDLE1BQWEsT0FBTztJQUNsQixNQUFNLENBQUMsRUFBRSxDQUFDLE1BQWM7UUFDdEIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUM1QixDQUFDO0lBSUQsWUFBNEIsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDeEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxpQkFBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3RFLENBQUM7SUFFSyw2QkFBNkIsQ0FBQyxJQUFZOztZQUU5QyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1lBR2pFLE1BQU0scUJBQXFCLEdBQUcsTUFBTSxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUE7WUFHN0YsTUFBTSxtQkFBbUIsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FDbkUscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FDNUQsQ0FBQTtZQUVELE1BQU0sb0JBQW9CLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQ3JFLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxJQUFJ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LENBQUMsSUFBQSxnQkFBTyxFQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDdkMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFBLG1CQUFVLEVBQUMsNEJBQTRCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUN6RSxDQUFBO1FBQ0gsQ0FBQztLQUFBO0NBQ0Y7QUFsSUQsMEJBa0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtKZW5raW5zLCBKb2JzQW5kVmlld3MgYXMgSmVua2luc0pvYnNBbmRWaWV3c30gZnJvbSAnLi9qZW5raW5zJ1xuaW1wb3J0IHtGaWxlcywgSm9ic0FuZFZpZXdzIGFzIEZpbGVzSm9ic0FuZFZpZXdzfSBmcm9tICcuL2ZpbGVzJ1xuaW1wb3J0IHtDb25maWd9IGZyb20gJy4vY29uZmlnJ1xuXG5pbXBvcnQge3ByaW50bG4sIHByaW50RXJyb3J9IGZyb20gJy4vb3V0cHV0J1xuXG5leHBvcnQgY2xhc3MgQ29tbWFuZCB7XG4gIHN0YXRpYyBvZihjb25maWc6IENvbmZpZyk6IENvbW1hbmQge1xuICAgIHJldHVybiBuZXcgQ29tbWFuZChjb25maWcpXG4gIH1cblxuICBwcml2YXRlIGplbmtpbnM6IEplbmtpbnNcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByaXZhdGUgY29uZmlnOiBDb25maWcpIHtcbiAgICB0aGlzLmplbmtpbnMgPSBKZW5raW5zLm9mKGNvbmZpZy5iYXNlVXJsLCBjb25maWcudXNlciwgY29uZmlnLnRva2VuKVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlSm9ic0FuZFZpZXdzQmFzZWRPblBhdGgocGF0aDogc3RyaW5nKSB7XG4gICAgLy8gZ2V0IGxpc3Qgb2YgamVua2lucyBqb2JzIGFuZCB2aWV3c1xuICAgIGNvbnN0IGplbmtpbnNKb2JzQW5kVmlld3MgPSBhd2FpdCB0aGlzLmplbmtpbnMubGlzdEpvYnNBbmRWaWV3cygpXG5cbiAgICAvLyBnZXQgYSBsaXN0IG9mIGpvYnMgYW5kIHZpZXdzIGJhc2VkIG9uIHRoZSBnaXZlbiBkaXJlY3RvcnlcbiAgICBjb25zdCBmaWxlQmFzZWRKb2JzQW5kVmlld3MgPSBhd2FpdCBGaWxlcy5vZihwYXRoLCB0aGlzLmNvbmZpZy5uYW1lUHJlZml4KS5saXN0Sm9ic0FuZFZpZXdzKClcblxuICAgIC8vIGxvb2t1cCBhbGwgamVua2lucyBqb2JzIGFuZCB2aWV3cywgd2hpY2ggZXhpc3RzIG9uIHRoZSBmaWxlIHN5c3RlbSBhcyB3ZWxsIGFuZCBkZWxldGUgdGhlbSBvbiBqZW5raW5zXG4gICAgY29uc3QgamVua2luc0pvYnNUb0RlbGV0ZSA9IGplbmtpbnNKb2JzQW5kVmlld3Muam9icy5maWx0ZXIoKG5hbWUpID0+XG4gICAgICBmaWxlQmFzZWRKb2JzQW5kVmlld3Muam9icy5zb21lKChqb2IpID0+IGpvYi5uYW1lID09PSBuYW1lKSxcbiAgICApXG5cbiAgICBjb25zdCBqZW5raW5zVmlld3NUb0RlbGV0ZSA9IGplbmtpbnNKb2JzQW5kVmlld3Mudmlld3MuZmlsdGVyKChuYW1lKSA9PlxuICAgICAgZmlsZUJhc2VkSm9ic0FuZFZpZXdzLnZpZXdzLnNvbWUoKHZpZXcpID0+IHZpZXcubmFtZSA9PT0gbmFtZSksXG4gICAgKVxuXG4gICAgLy8gZGVsZXRlIHZpZXdzXG4gICAgamVua2luc1ZpZXdzVG9EZWxldGUuZm9yRWFjaCgobmFtZSkgPT5cbiAgICAgIHRoaXMuamVua2luc1xuICAgICAgICAuZGVsZXRlVmlld0J5TmFtZShuYW1lKVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW1hdIHZpZXcgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgZGVsZXRpbmcgdmlldyBcIiR7bmFtZX1cImAsIGUpKSxcbiAgICApXG5cbiAgICAvLyBkZWxldGUgam9ic1xuICAgIGplbmtpbnNKb2JzVG9EZWxldGUuZm9yRWFjaCgobmFtZSkgPT5cbiAgICAgIHRoaXMuamVua2luc1xuICAgICAgICAuZGVsZXRlSm9iQnlOYW1lKG5hbWUpXG4gICAgICAgIC50aGVuKChuKSA9PiBwcmludGxuKGBbWF0gam9iIFwiJHtufVwiYCkpXG4gICAgICAgIC5jYXRjaCgoZSkgPT4gcHJpbnRFcnJvcihgWyFdIGVycm9yIGRlbGV0aW5nIGpvYiBcIiR7bmFtZX1cImAsIGUpKSxcbiAgICApXG4gIH1cblxuICBhc3luYyBzeW5jSm9ic0FuZFZpZXdzQmFzZWRPblBhdGgocGF0aDogc3RyaW5nKSB7XG4gICAgLy8gZ2V0IGxpc3Qgb2YgamVua2lucyBqb2JzIGFuZCB2aWV3c1xuICAgIGNvbnN0IGplbmtpbnNKb2JzQW5kVmlld3MgPSBhd2FpdCB0aGlzLmplbmtpbnMubGlzdEpvYnNBbmRWaWV3cygpXG5cbiAgICAvLyBnZXQgYSBsaXN0IG9mIGpvYnMgYW5kIHZpZXdzIGJhc2VkIG9uIHRoZSBnaXZlbiBkaXJlY3RvcnlcbiAgICBjb25zdCBmaWxlQmFzZWRKb2JzQW5kVmlld3MgPSBhd2FpdCBGaWxlcy5vZihwYXRoLCB0aGlzLmNvbmZpZy5uYW1lUHJlZml4KS5saXN0Sm9ic0FuZFZpZXdzKClcblxuICAgIGF3YWl0IHRoaXMuc3luY0pvYnNCYXNlZE9uUGF0aChqZW5raW5zSm9ic0FuZFZpZXdzLCBmaWxlQmFzZWRKb2JzQW5kVmlld3MpXG4gICAgYXdhaXQgdGhpcy5zeW5jVmlld3NCYXNlZE9uUGF0aChqZW5raW5zSm9ic0FuZFZpZXdzLCBmaWxlQmFzZWRKb2JzQW5kVmlld3MpXG4gIH1cblxuICBhc3luYyBzeW5jSm9ic0Jhc2VkT25QYXRoKGplbmtpbnNKb2JzQW5kVmlld3M6IEplbmtpbnNKb2JzQW5kVmlld3MsIGZpbGVCYXNlZEpvYnNBbmRWaWV3czogRmlsZXNKb2JzQW5kVmlld3MpIHtcbiAgICAvLyBkZXRlcm1pbmUgamVua2lucyBqb2JzLCB3aGljaCBETyBOT1QgZXhpc3Qgb24gZmlsZSBzeXN0ZW0gYW55bW9yZSAtLT4gdGhlc2Ugam9icyB3aWxsIGJlIERFTEVURURcbiAgICAvLyAoaG93ZXZlciwgRE8gTk9UIGRlbGV0ZSBqb2JzLCB3aGljaCBhcmVudCAnbWFuYWdlZCcgYnkgamVubnkpXG4gICAgY29uc3QgamVua2luc0pvYnNUb0RlbGV0ZSA9IGplbmtpbnNKb2JzQW5kVmlld3Muam9ic1xuICAgICAgLmZpbHRlcigobmFtZSkgPT4gbmFtZS5zdGFydHNXaXRoKHRoaXMuY29uZmlnLm5hbWVQcmVmaXgpKVxuICAgICAgLmZpbHRlcigobmFtZSkgPT4gIWZpbGVCYXNlZEpvYnNBbmRWaWV3cy5qb2JzLnNvbWUoKGpvYikgPT4gam9iLm5hbWUgPT09IG5hbWUpKVxuXG4gICAgLy8gZGV0ZXJtaW5lIGplbmtpbnMgam9icywgd2hpY2ggZXhpc3Qgb24gZmlsZSBzeXN0ZW0gQlVUIERPIE5PVCBleGlzdCBvbiBqZW5raW5zIC0tPiB0aGVzZSBqb2JzIHdpbGwgYmUgQ1JFQVRFRFxuICAgIGNvbnN0IGZpbGVCYXNlZEpvYnNUb0NyZWF0ZSA9IGZpbGVCYXNlZEpvYnNBbmRWaWV3cy5qb2JzLmZpbHRlcihcbiAgICAgIChqb2IpID0+ICFqZW5raW5zSm9ic0FuZFZpZXdzLmpvYnMuc29tZSgobmFtZSkgPT4gam9iLm5hbWUgPT09IG5hbWUpLFxuICAgIClcblxuICAgIC8vIGRldGVybWluZSBqZW5raW5zIGpvYnMsIHdoaWNoIGV4aXN0IG9uIGZpbGUgc3lzdGVtIEFORCBvbiBqZW5raW5zIC0tPiB0aGVzZSBqb2JzJyBzY3JpcHQgd2lsbCBiZSBVUERBVEVEXG4gICAgY29uc3QgZmlsZUJhc2VkSm9ic1RvVXBkYXRlID0gZmlsZUJhc2VkSm9ic0FuZFZpZXdzLmpvYnMuZmlsdGVyKChqb2IpID0+XG4gICAgICBqZW5raW5zSm9ic0FuZFZpZXdzLmpvYnMuc29tZSgobmFtZSkgPT4gam9iLm5hbWUgPT09IG5hbWUpLFxuICAgIClcblxuICAgIC8vIGRlbGV0ZSBqb2JzXG4gICAgamVua2luc0pvYnNUb0RlbGV0ZS5mb3JFYWNoKChuYW1lKSA9PlxuICAgICAgdGhpcy5qZW5raW5zXG4gICAgICAgIC5kZWxldGVKb2JCeU5hbWUobmFtZSlcbiAgICAgICAgLnRoZW4oKG4pID0+IHByaW50bG4oYFtYXSBqb2IgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgZGVsZXRpbmcgam9iIFwiJHtuYW1lfVwiYCwgZSkpLFxuICAgIClcblxuICAgIC8vIGNyZWF0ZSBqb2JzXG4gICAgZmlsZUJhc2VkSm9ic1RvQ3JlYXRlLmZvckVhY2goKGpvYikgPT5cbiAgICAgIHRoaXMuamVua2luc1xuICAgICAgICAuY3JlYXRlSm9iRnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmpvYlRlbXBsYXRlLCBqb2IubmFtZSwgam9iLnNjcmlwdClcbiAgICAgICAgLnRoZW4oKG4pID0+IHByaW50bG4oYFtDXSBqb2IgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgY3JlYXRpbmcgam9iIFwiJHtqb2IubmFtZX1cImAsIGUpKSxcbiAgICApXG5cbiAgICAvLyB1cGRhdGUgam9ic1xuICAgIGZpbGVCYXNlZEpvYnNUb1VwZGF0ZS5mb3JFYWNoKChqb2IpID0+XG4gICAgICB0aGlzLmplbmtpbnNcbiAgICAgICAgLnVwZGF0ZUpvYlBpcGVsaW5lU2NyaXB0KGpvYi5uYW1lLCBqb2Iuc2NyaXB0KVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW1VdIGpvYiBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciB1cGRhdGluZyBqb2IgXCIke2pvYi5uYW1lfVwiYCwgZSkpLFxuICAgIClcbiAgfVxuXG4gIGFzeW5jIHN5bmNWaWV3c0Jhc2VkT25QYXRoKGplbmtpbnNKb2JzQW5kVmlld3M6IEplbmtpbnNKb2JzQW5kVmlld3MsIGZpbGVCYXNlZEpvYnNBbmRWaWV3czogRmlsZXNKb2JzQW5kVmlld3MpIHtcbiAgICAvLyBkZXRlcm1pbmUgamVua2lucyB2aWV3cywgd2hpY2ggRE8gTk9UIGV4aXN0IG9uIGZpbGUgc3lzdGVtIGFueW1vcmUgLS0+IHRoZXNlIHZpZXdzIHdpbGwgYmUgREVMRVRFRFxuICAgIC8vIChob3dldmVyLCBETyBOT1QgZGVsZXRlIHZpZXdzLCB3aGljaCBhcmVudCAnbWFuYWdlZCcgYnkgamVubnkpXG4gICAgY29uc3QgamVua2luc1ZpZXdzVG9EZWxldGUgPSBqZW5raW5zSm9ic0FuZFZpZXdzLnZpZXdzXG4gICAgICAuZmlsdGVyKChuYW1lKSA9PiBuYW1lLnN0YXJ0c1dpdGgodGhpcy5jb25maWcubmFtZVByZWZpeCkpXG4gICAgICAuZmlsdGVyKChuYW1lKSA9PiAhZmlsZUJhc2VkSm9ic0FuZFZpZXdzLnZpZXdzLnNvbWUoKHZpZXcpID0+IHZpZXcubmFtZSA9PT0gbmFtZSkpXG5cbiAgICAvLyBkZXRlcm1pbmUgamVua2lucyB2aWV3cywgd2hpY2ggZXhpc3Qgb24gZmlsZSBzeXN0ZW0gQlVUIERPIE5PVCBleGlzdCBvbiBqZW5raW5zIC0tPiB0aGVzZSB2aWV3cyB3aWxsIGJlIENSRUFURURcbiAgICBjb25zdCBmaWxlQmFzZWRWaWV3c1RvQ3JlYXRlID0gZmlsZUJhc2VkSm9ic0FuZFZpZXdzLnZpZXdzLmZpbHRlcihcbiAgICAgICh2aWV3KSA9PiAhamVua2luc0pvYnNBbmRWaWV3cy52aWV3cy5zb21lKChuYW1lKSA9PiB2aWV3Lm5hbWUgPT09IG5hbWUpLFxuICAgIClcblxuICAgIC8vIC8vIGRldGVybWluZSBqZW5raW5zIHZpZXdzLCB3aGljaCBleGlzdCBvbiBmaWxlIHN5c3RlbSBBTkQgb24gamVua2lucyAtLT4gbm90aGluZyBoYXMgdG8gYmUgZG9uZSB3aXRoIHRoZW0gIVxuICAgIC8vIGNvbnN0IGZpbGVCYXNlZFZpZXdzVG9VcGRhdGUgPSBmaWxlQmFzZWRKb2JzQW5kVmlld3Mudmlld3MuZmlsdGVyKCh2aWV3KSA9PlxuICAgIC8vICAgamVua2luc0pvYnNBbmRWaWV3cy52aWV3cy5zb21lKChuYW1lKSA9PiB2aWV3Lm5hbWUgPT09IG5hbWUpLFxuICAgIC8vIClcblxuICAgIC8vIGRlbGV0ZSB2aWV3c1xuICAgIGplbmtpbnNWaWV3c1RvRGVsZXRlLmZvckVhY2goKG5hbWUpID0+XG4gICAgICB0aGlzLmplbmtpbnNcbiAgICAgICAgLmRlbGV0ZVZpZXdCeU5hbWUobmFtZSlcbiAgICAgICAgLnRoZW4oKG4pID0+IHByaW50bG4oYFtYXSB2aWV3IFwiJHtufVwiYCkpXG4gICAgICAgIC5jYXRjaCgoZSkgPT4gcHJpbnRFcnJvcihgWyFdIGVycm9yIGRlbGV0aW5nIHZpZXcgXCIke25hbWV9XCJgLCBlKSksXG4gICAgKVxuXG4gICAgLy8gY3JlYXRlIHZpZXdzXG4gICAgZmlsZUJhc2VkVmlld3NUb0NyZWF0ZS5mb3JFYWNoKCh2aWV3KSA9PlxuICAgICAgdGhpcy5qZW5raW5zXG4gICAgICAgIC5jcmVhdGVSZWdleEJhc2VkTGlzdFZpZXcodmlldy5uYW1lLCB2aWV3LnJlZ2V4KVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW0NdIHZpZXcgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgY3JlYXRpbmcgdmlldyBcIiR7dmlldy5uYW1lfVwiYCwgZSkpLFxuICAgIClcbiAgfVxufVxuIl19