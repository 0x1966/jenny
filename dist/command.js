"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Command = void 0;
const jenkins_1 = require("./jenkins");
const files_1 = require("./files");
const output_1 = require("./output");
const watch_1 = require("./watch");
class Command {
    static of(config) {
        return new Command(config);
    }
    constructor(config) {
        this.config = config;
        this.jenkins = jenkins_1.Jenkins.of(config.baseUrl, config.user, config.token);
    }
    watchAndSyncJobsAndViewsBasedOnPath(path) {
        (0, watch_1.watch)(path, '**/Jenkinsfile', {
            change: this.onJenkinsfileChange.bind(this),
        });
    }
    onJenkinsfileChange(workingDir, path) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsAndViews = yield this.jenkins.listJobsAndViews();
            const job = yield files_1.Files.of(workingDir, this.config.namePrefix).getJobByFilename(path);
            const exists = jenkinsJobsAndViews.jobs.some((name) => name === job.name);
            if (exists) {
                this.jenkins
                    .updateJobPipelineScript(job.name, job.script)
                    .then((n) => (0, output_1.println)(`[U] job "${n}"`))
                    .catch((e) => (0, output_1.printError)(`[!] error updating job "${job.name}"`, e));
            }
            else {
                (0, output_1.printError)(`[!] unable to update job "${job.name}" since no matching Jenkins job exists`);
            }
        });
    }
    deleteJobsAndViewsBasedOnPath(path) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsAndViews = yield this.jenkins.listJobsAndViews();
            const fileBasedJobsAndViews = yield files_1.Files.of(path, this.config.namePrefix).listJobsAndViews();
            const jenkinsJobsToDelete = jenkinsJobsAndViews.jobs.filter((name) => fileBasedJobsAndViews.jobs.some((job) => job.name === name));
            const jenkinsViewsToDelete = jenkinsJobsAndViews.views.filter((name) => fileBasedJobsAndViews.views.some((view) => view.name === name));
            jenkinsViewsToDelete.forEach((name) => this.jenkins
                .deleteViewByName(name)
                .then((n) => (0, output_1.println)(`[X] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting view "${name}"`, e)));
            jenkinsJobsToDelete.forEach((name) => this.jenkins
                .deleteJobByName(name)
                .then((n) => (0, output_1.println)(`[X] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting job "${name}"`, e)));
        });
    }
    syncJobsAndViewsBasedOnPath(path) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsAndViews = yield this.jenkins.listJobsAndViews();
            const fileBasedJobsAndViews = yield files_1.Files.of(path, this.config.namePrefix).listJobsAndViews();
            yield this.syncJobsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews);
            yield this.syncViewsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews);
        });
    }
    syncJobsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsJobsToDelete = jenkinsJobsAndViews.jobs
                .filter((name) => name.startsWith(this.config.namePrefix))
                .filter((name) => !fileBasedJobsAndViews.jobs.some((job) => job.name === name));
            const fileBasedJobsToCreate = fileBasedJobsAndViews.jobs.filter((job) => !jenkinsJobsAndViews.jobs.some((name) => job.name === name));
            const fileBasedJobsToUpdate = fileBasedJobsAndViews.jobs.filter((job) => jenkinsJobsAndViews.jobs.some((name) => job.name === name));
            jenkinsJobsToDelete.forEach((name) => this.jenkins
                .deleteJobByName(name)
                .then((n) => (0, output_1.println)(`[X] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting job "${name}"`, e)));
            fileBasedJobsToCreate.forEach((job) => this.jenkins
                .createJobFromTemplate(this.config.jobTemplate, job.name, job.script)
                .then((n) => (0, output_1.println)(`[C] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error creating job "${job.name}"`, e)));
            fileBasedJobsToUpdate.forEach((job) => this.jenkins
                .updateJobPipelineScript(job.name, job.script)
                .then((n) => (0, output_1.println)(`[U] job "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error updating job "${job.name}"`, e)));
        });
    }
    syncViewsBasedOnPath(jenkinsJobsAndViews, fileBasedJobsAndViews) {
        return __awaiter(this, void 0, void 0, function* () {
            const jenkinsViewsToDelete = jenkinsJobsAndViews.views
                .filter((name) => name.startsWith(this.config.namePrefix))
                .filter((name) => !fileBasedJobsAndViews.views.some((view) => view.name === name));
            const fileBasedViewsToCreate = fileBasedJobsAndViews.views.filter((view) => !jenkinsJobsAndViews.views.some((name) => view.name === name));
            jenkinsViewsToDelete.forEach((name) => this.jenkins
                .deleteViewByName(name)
                .then((n) => (0, output_1.println)(`[X] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error deleting view "${name}"`, e)));
            fileBasedViewsToCreate.forEach((view) => this.jenkins
                .createRegexBasedListView(view.name, view.regex)
                .then((n) => (0, output_1.println)(`[C] view "${n}"`))
                .catch((e) => (0, output_1.printError)(`[!] error creating view "${view.name}"`, e)));
        });
    }
}
exports.Command = Command;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLHVDQUFzRTtBQUN0RSxtQ0FBZ0U7QUFHaEUscUNBQTRDO0FBQzVDLG1DQUE2QjtBQUU3QixNQUFhLE9BQU87SUFDbEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFjO1FBQ3RCLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDNUIsQ0FBQztJQUlELFlBQTRCLE1BQWM7UUFBZCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEdBQUcsaUJBQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUN0RSxDQUFDO0lBRUQsbUNBQW1DLENBQUMsSUFBWTtRQUM5QyxJQUFBLGFBQUssRUFBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDNUIsTUFBTSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQzVDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFYSxtQkFBbUIsQ0FBQyxVQUFrQixFQUFFLElBQVk7O1lBRWhFLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUE7WUFFakUsTUFBTSxHQUFHLEdBQUcsTUFBTSxhQUFLLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFBO1lBR3JGLE1BQU0sTUFBTSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsSUFBSSxD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LGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDdkMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFBLG1CQUFVLEVBQUMsNEJBQTRCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUN6RSxDQUFBO1FBQ0gsQ0FBQztLQUFBO0NBQ0Y7QUE1SkQsMEJBNEpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtKZW5raW5zLCBKb2JzQW5kVmlld3MgYXMgSmVua2luc0pvYnNBbmRWaWV3c30gZnJvbSAnLi9qZW5raW5zJ1xuaW1wb3J0IHtGaWxlcywgSm9ic0FuZFZpZXdzIGFzIEZpbGVzSm9ic0FuZFZpZXdzfSBmcm9tICcuL2ZpbGVzJ1xuaW1wb3J0IHtDb25maWd9IGZyb20gJy4vY29uZmlnJ1xuXG5pbXBvcnQge3ByaW50bG4sIHByaW50RXJyb3J9IGZyb20gJy4vb3V0cHV0J1xuaW1wb3J0IHt3YXRjaH0gZnJvbSAnLi93YXRjaCdcblxuZXhwb3J0IGNsYXNzIENvbW1hbmQge1xuICBzdGF0aWMgb2YoY29uZmlnOiBDb25maWcpOiBDb21tYW5kIHtcbiAgICByZXR1cm4gbmV3IENvbW1hbmQoY29uZmlnKVxuICB9XG5cbiAgcHJpdmF0ZSBqZW5raW5zOiBKZW5raW5zXG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogQ29uZmlnKSB7XG4gICAgdGhpcy5qZW5raW5zID0gSmVua2lucy5vZihjb25maWcuYmFzZVVybCwgY29uZmlnLnVzZXIsIGNvbmZpZy50b2tlbilcbiAgfVxuXG4gIHdhdGNoQW5kU3luY0pvYnNBbmRWaWV3c0Jhc2VkT25QYXRoKHBhdGg6IHN0cmluZykge1xuICAgIHdhdGNoKHBhdGgsICcqKi9KZW5raW5zZmlsZScsIHtcbiAgICAgIGNoYW5nZTogdGhpcy5vbkplbmtpbnNmaWxlQ2hhbmdlLmJpbmQodGhpcyksXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgb25KZW5raW5zZmlsZUNoYW5nZSh3b3JraW5nRGlyOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgIC8vIGdldCBsaXN0IG9mIGplbmtpbnMgam9icyBhbmQgdmlld3NcbiAgICBjb25zdCBqZW5raW5zSm9ic0FuZFZpZXdzID0gYXdhaXQgdGhpcy5qZW5raW5zLmxpc3RKb2JzQW5kVmlld3MoKVxuXG4gICAgY29uc3Qgam9iID0gYXdhaXQgRmlsZXMub2Yod29ya2luZ0RpciwgdGhpcy5jb25maWcubmFtZVByZWZpeCkuZ2V0Sm9iQnlGaWxlbmFtZShwYXRoKVxuXG4gICAgLy8gY2hlY2ssIGlmIGEgamVua2lucyBqb2IgZXhpc3RzIGZvciB0aGUgaWRlbnRpZmllZCBqb2Igb24gdGhlIGZpbGUgc3lzdGVtIC0tPiB0aGlzIGpvYidzIHNjcmlwdCB3aWxsIGJlIFVQREFURURcbiAgICBjb25zdCBleGlzdHMgPSBqZW5raW5zSm9ic0FuZFZpZXdzLmpvYnMuc29tZSgobmFtZSkgPT4gbmFtZSA9PT0gam9iLm5hbWUpXG5cbiAgICAvLyBpZiBqb2IgZXhpc3RzIG9uIGplbmtpbnMsIHRoZW4gdXBkYXRlIGl0cyBzY3JpcHRcbiAgICBpZiAoZXhpc3RzKSB7XG4gICAgICB0aGlzLmplbmtpbnNcbiAgICAgICAgLnVwZGF0ZUpvYlBpcGVsaW5lU2NyaXB0KGpvYi5uYW1lLCBqb2Iuc2NyaXB0KVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW1VdIGpvYiBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciB1cGRhdGluZyBqb2IgXCIke2pvYi5uYW1lfVwiYCwgZSkpXG4gICAgfSBlbHNlIHtcbiAgICAgIHByaW50RXJyb3IoYFshXSB1bmFibGUgdG8gdXBkYXRlIGpvYiBcIiR7am9iLm5hbWV9XCIgc2luY2Ugbm8gbWF0Y2hpbmcgSmVua2lucyBqb2IgZXhpc3RzYClcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVKb2JzQW5kVmlld3NCYXNlZE9uUGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBnZXQgbGlzdCBvZiBqZW5raW5zIGpvYnMgYW5kIHZpZXdzXG4gICAgY29uc3QgamVua2luc0pvYnNBbmRWaWV3cyA9IGF3YWl0IHRoaXMuamVua2lucy5saXN0Sm9ic0FuZFZpZXdzKClcblxuICAgIC8vIGdldCBhIGxpc3Qgb2Ygam9icyBhbmQgdmlld3MgYmFzZWQgb24gdGhlIGdpdmVuIGRpcmVjdG9yeVxuICAgIGNvbnN0IGZpbGVCYXNlZEpvYnNBbmRWaWV3cyA9IGF3YWl0IEZpbGVzLm9mKHBhdGgsIHRoaXMuY29uZmlnLm5hbWVQcmVmaXgpLmxpc3RKb2JzQW5kVmlld3MoKVxuXG4gICAgLy8gbG9va3VwIGFsbCBqZW5raW5zIGpvYnMgYW5kIHZpZXdzLCB3aGljaCBleGlzdHMgb24gdGhlIGZpbGUgc3lzdGVtIGFzIHdlbGwgYW5kIGRlbGV0ZSB0aGVtIG9uIGplbmtpbnNcbiAgICBjb25zdCBqZW5raW5zSm9ic1RvRGVsZXRlID0gamVua2luc0pvYnNBbmRWaWV3cy5qb2JzLmZpbHRlcigobmFtZSkgPT5cbiAgICAgIGZpbGVCYXNlZEpvYnNBbmRWaWV3cy5qb2JzLnNvbWUoKGpvYikgPT4gam9iLm5hbWUgPT09IG5hbWUpLFxuICAgIClcblxuICAgIGNvbnN0IGplbmtpbnNWaWV3c1RvRGVsZXRlID0gamVua2luc0pvYnNBbmRWaWV3cy52aWV3cy5maWx0ZXIoKG5hbWUpID0+XG4gICAgICBmaWxlQmFzZWRKb2JzQW5kVmlld3Mudmlld3Muc29tZSgodmlldykgPT4gdmlldy5uYW1lID09PSBuYW1lKSxcbiAgICApXG5cbiAgICAvLyBkZWxldGUgdmlld3NcbiAgICBqZW5raW5zVmlld3NUb0RlbGV0ZS5mb3JFYWNoKChuYW1lKSA9PlxuICAgICAgdGhpcy5qZW5raW5zXG4gICAgICAgIC5kZWxldGVWaWV3QnlOYW1lKG5hbWUpXG4gICAgICAgIC50aGVuKChuKSA9PiBwcmludGxuKGBbWF0gdmlldyBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciBkZWxldGluZyB2aWV3IFwiJHtuYW1lfVwiYCwgZSkpLFxuICAgIClcblxuICAgIC8vIGRlbGV0ZSBqb2JzXG4gICAgamVua2luc0pvYnNUb0RlbGV0ZS5mb3JFYWNoKChuYW1lKSA9PlxuICAgICAgdGhpcy5qZW5raW5zXG4gICAgICAgIC5kZWxldGVKb2JCeU5hbWUobmFtZSlcbiAgICAgICAgLnRoZW4oKG4pID0+IHByaW50bG4oYFtYXSBqb2IgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgZGVsZXRpbmcgam9iIFwiJHtuYW1lfVwiYCwgZSkpLFxuICAgIClcbiAgfVxuXG4gIGFzeW5jIHN5bmNKb2JzQW5kVmlld3NCYXNlZE9uUGF0aChwYXRoOiBzdHJpbmcpIHtcbiAgICAvLyBnZXQgbGlzdCBvZiBqZW5raW5zIGpvYnMgYW5kIHZpZXdzXG4gICAgY29uc3QgamVua2luc0pvYnNBbmRWaWV3cyA9IGF3YWl0IHRoaXMuamVua2lucy5saXN0Sm9ic0FuZFZpZXdzKClcblxuICAgIC8vIGdldCBhIGxpc3Qgb2Ygam9icyBhbmQgdmlld3MgYmFzZWQgb24gdGhlIGdpdmVuIGRpcmVjdG9yeVxuICAgIGNvbnN0IGZpbGVCYXNlZEpvYnNBbmRWaWV3cyA9IGF3YWl0IEZpbGVzLm9mKHBhdGgsIHRoaXMuY29uZmlnLm5hbWVQcmVmaXgpLmxpc3RKb2JzQW5kVmlld3MoKVxuXG4gICAgYXdhaXQgdGhpcy5zeW5jSm9ic0Jhc2VkT25QYXRoKGplbmtpbnNKb2JzQW5kVmlld3MsIGZpbGVCYXNlZEpvYnNBbmRWaWV3cylcbiAgICBhd2FpdCB0aGlzLnN5bmNWaWV3c0Jhc2VkT25QYXRoKGplbmtpbnNKb2JzQW5kVmlld3MsIGZpbGVCYXNlZEpvYnNBbmRWaWV3cylcbiAgfVxuXG4gIGFzeW5jIHN5bmNKb2JzQmFzZWRPblBhdGgoamVua2luc0pvYnNBbmRWaWV3czogSmVua2luc0pvYnNBbmRWaWV3cywgZmlsZUJhc2VkSm9ic0FuZFZpZXdzOiBGaWxlc0pvYnNBbmRWaWV3cykge1xuICAgIC8vIGRldGVybWluZSBqZW5raW5zIGpvYnMsIHdoaWNoIERPIE5PVCBleGlzdCBvbiBmaWxlIHN5c3RlbSBhbnltb3JlIC0tPiB0aGVzZSBqb2JzIHdpbGwgYmUgREVMRVRFRFxuICAgIC8vIChob3dldmVyLCBETyBOT1QgZGVsZXRlIGpvYnMsIHdoaWNoIGFyZW50ICdtYW5hZ2VkJyBieSBqZW5ueSlcbiAgICBjb25zdCBqZW5raW5zSm9ic1RvRGVsZXRlID0gamVua2luc0pvYnNBbmRWaWV3cy5qb2JzXG4gICAgICAuZmlsdGVyKChuYW1lKSA9PiBuYW1lLnN0YXJ0c1dpdGgodGhpcy5jb25maWcubmFtZVByZWZpeCkpXG4gICAgICAuZmlsdGVyKChuYW1lKSA9PiAhZmlsZUJhc2VkSm9ic0FuZFZpZXdzLmpvYnMuc29tZSgoam9iKSA9PiBqb2IubmFtZSA9PT0gbmFtZSkpXG5cbiAgICAvLyBkZXRlcm1pbmUgamVua2lucyBqb2JzLCB3aGljaCBleGlzdCBvbiBmaWxlIHN5c3RlbSBCVVQgRE8gTk9UIGV4aXN0IG9uIGplbmtpbnMgLS0+IHRoZXNlIGpvYnMgd2lsbCBiZSBDUkVBVEVEXG4gICAgY29uc3QgZmlsZUJhc2VkSm9ic1RvQ3JlYXRlID0gZmlsZUJhc2VkSm9ic0FuZFZpZXdzLmpvYnMuZmlsdGVyKFxuICAgICAgKGpvYikgPT4gIWplbmtpbnNKb2JzQW5kVmlld3Muam9icy5zb21lKChuYW1lKSA9PiBqb2IubmFtZSA9PT0gbmFtZSksXG4gICAgKVxuXG4gICAgLy8gZGV0ZXJtaW5lIGplbmtpbnMgam9icywgd2hpY2ggZXhpc3Qgb24gZmlsZSBzeXN0ZW0gQU5EIG9uIGplbmtpbnMgLS0+IHRoZXNlIGpvYnMnIHNjcmlwdCB3aWxsIGJlIFVQREFURURcbiAgICBjb25zdCBmaWxlQmFzZWRKb2JzVG9VcGRhdGUgPSBmaWxlQmFzZWRKb2JzQW5kVmlld3Muam9icy5maWx0ZXIoKGpvYikgPT5cbiAgICAgIGplbmtpbnNKb2JzQW5kVmlld3Muam9icy5zb21lKChuYW1lKSA9PiBqb2IubmFtZSA9PT0gbmFtZSksXG4gICAgKVxuXG4gICAgLy8gZGVsZXRlIGpvYnNcbiAgICBqZW5raW5zSm9ic1RvRGVsZXRlLmZvckVhY2goKG5hbWUpID0+XG4gICAgICB0aGlzLmplbmtpbnNcbiAgICAgICAgLmRlbGV0ZUpvYkJ5TmFtZShuYW1lKVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW1hdIGpvYiBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciBkZWxldGluZyBqb2IgXCIke25hbWV9XCJgLCBlKSksXG4gICAgKVxuXG4gICAgLy8gY3JlYXRlIGpvYnNcbiAgICBmaWxlQmFzZWRKb2JzVG9DcmVhdGUuZm9yRWFjaCgoam9iKSA9PlxuICAgICAgdGhpcy5qZW5raW5zXG4gICAgICAgIC5jcmVhdGVKb2JGcm9tVGVtcGxhdGUodGhpcy5jb25maWcuam9iVGVtcGxhdGUsIGpvYi5uYW1lLCBqb2Iuc2NyaXB0KVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW0NdIGpvYiBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciBjcmVhdGluZyBqb2IgXCIke2pvYi5uYW1lfVwiYCwgZSkpLFxuICAgIClcblxuICAgIC8vIHVwZGF0ZSBqb2JzXG4gICAgZmlsZUJhc2VkSm9ic1RvVXBkYXRlLmZvckVhY2goKGpvYikgPT5cbiAgICAgIHRoaXMuamVua2luc1xuICAgICAgICAudXBkYXRlSm9iUGlwZWxpbmVTY3JpcHQoam9iLm5hbWUsIGpvYi5zY3JpcHQpXG4gICAgICAgIC50aGVuKChuKSA9PiBwcmludGxuKGBbVV0gam9iIFwiJHtufVwiYCkpXG4gICAgICAgIC5jYXRjaCgoZSkgPT4gcHJpbnRFcnJvcihgWyFdIGVycm9yIHVwZGF0aW5nIGpvYiBcIiR7am9iLm5hbWV9XCJgLCBlKSksXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgc3luY1ZpZXdzQmFzZWRPblBhdGgoamVua2luc0pvYnNBbmRWaWV3czogSmVua2luc0pvYnNBbmRWaWV3cywgZmlsZUJhc2VkSm9ic0FuZFZpZXdzOiBGaWxlc0pvYnNBbmRWaWV3cykge1xuICAgIC8vIGRldGVybWluZSBqZW5raW5zIHZpZXdzLCB3aGljaCBETyBOT1QgZXhpc3Qgb24gZmlsZSBzeXN0ZW0gYW55bW9yZSAtLT4gdGhlc2Ugdmlld3Mgd2lsbCBiZSBERUxFVEVEXG4gICAgLy8gKGhvd2V2ZXIsIERPIE5PVCBkZWxldGUgdmlld3MsIHdoaWNoIGFyZW50ICdtYW5hZ2VkJyBieSBqZW5ueSlcbiAgICBjb25zdCBqZW5raW5zVmlld3NUb0RlbGV0ZSA9IGplbmtpbnNKb2JzQW5kVmlld3Mudmlld3NcbiAgICAgIC5maWx0ZXIoKG5hbWUpID0+IG5hbWUuc3RhcnRzV2l0aCh0aGlzLmNvbmZpZy5uYW1lUHJlZml4KSlcbiAgICAgIC5maWx0ZXIoKG5hbWUpID0+ICFmaWxlQmFzZWRKb2JzQW5kVmlld3Mudmlld3Muc29tZSgodmlldykgPT4gdmlldy5uYW1lID09PSBuYW1lKSlcblxuICAgIC8vIGRldGVybWluZSBqZW5raW5zIHZpZXdzLCB3aGljaCBleGlzdCBvbiBmaWxlIHN5c3RlbSBCVVQgRE8gTk9UIGV4aXN0IG9uIGplbmtpbnMgLS0+IHRoZXNlIHZpZXdzIHdpbGwgYmUgQ1JFQVRFRFxuICAgIGNvbnN0IGZpbGVCYXNlZFZpZXdzVG9DcmVhdGUgPSBmaWxlQmFzZWRKb2JzQW5kVmlld3Mudmlld3MuZmlsdGVyKFxuICAgICAgKHZpZXcpID0+ICFqZW5raW5zSm9ic0FuZFZpZXdzLnZpZXdzLnNvbWUoKG5hbWUpID0+IHZpZXcubmFtZSA9PT0gbmFtZSksXG4gICAgKVxuXG4gICAgLy8gLy8gZGV0ZXJtaW5lIGplbmtpbnMgdmlld3MsIHdoaWNoIGV4aXN0IG9uIGZpbGUgc3lzdGVtIEFORCBvbiBqZW5raW5zIC0tPiBub3RoaW5nIGhhcyB0byBiZSBkb25lIHdpdGggdGhlbSAhXG4gICAgLy8gY29uc3QgZmlsZUJhc2VkVmlld3NUb1VwZGF0ZSA9IGZpbGVCYXNlZEpvYnNBbmRWaWV3cy52aWV3cy5maWx0ZXIoKHZpZXcpID0+XG4gICAgLy8gICBqZW5raW5zSm9ic0FuZFZpZXdzLnZpZXdzLnNvbWUoKG5hbWUpID0+IHZpZXcubmFtZSA9PT0gbmFtZSksXG4gICAgLy8gKVxuXG4gICAgLy8gZGVsZXRlIHZpZXdzXG4gICAgamVua2luc1ZpZXdzVG9EZWxldGUuZm9yRWFjaCgobmFtZSkgPT5cbiAgICAgIHRoaXMuamVua2luc1xuICAgICAgICAuZGVsZXRlVmlld0J5TmFtZShuYW1lKVxuICAgICAgICAudGhlbigobikgPT4gcHJpbnRsbihgW1hdIHZpZXcgXCIke259XCJgKSlcbiAgICAgICAgLmNhdGNoKChlKSA9PiBwcmludEVycm9yKGBbIV0gZXJyb3IgZGVsZXRpbmcgdmlldyBcIiR7bmFtZX1cImAsIGUpKSxcbiAgICApXG5cbiAgICAvLyBjcmVhdGUgdmlld3NcbiAgICBmaWxlQmFzZWRWaWV3c1RvQ3JlYXRlLmZvckVhY2goKHZpZXcpID0+XG4gICAgICB0aGlzLmplbmtpbnNcbiAgICAgICAgLmNyZWF0ZVJlZ2V4QmFzZWRMaXN0Vmlldyh2aWV3Lm5hbWUsIHZpZXcucmVnZXgpXG4gICAgICAgIC50aGVuKChuKSA9PiBwcmludGxuKGBbQ10gdmlldyBcIiR7bn1cImApKVxuICAgICAgICAuY2F0Y2goKGUpID0+IHByaW50RXJyb3IoYFshXSBlcnJvciBjcmVhdGluZyB2aWV3IFwiJHt2aWV3Lm5hbWV9XCJgLCBlKSksXG4gICAgKVxuICB9XG59XG4iXX0=